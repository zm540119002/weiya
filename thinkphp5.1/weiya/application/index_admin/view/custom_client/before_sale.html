{extend name="template/admin_pc/base.html" /}
{block name="footer"}{/block}
{block name="content"}
<!--模板区 start-->
<section id="customItemTpl" style="display:none">
    <li class="custom_item" data-from_id="">
        <a href="javascript:void(0);" class="detele_chat">删除</a>
        <div class="avatar">
            <img src="public_img/default/chat_head.jpg">
            <span class="news_num"></span>
        </div>
        <div class="content">
            <p class="author"></p>
        </div>
    </li>
</section>
<section id="messageItemTpl" style="display:none;">
    <li><span class="create_time"></span></li>
    <li class="message_item others unread" data-id="">
        <div class="avatar">
            <img src="public_img/default/chat_head.jpg">
        </div>
        <div class="content">
            <div class="msg"></div>
        </div>
    </li>
</section>
<!--模板 end-->
<section class="f24 chat_content"></section>
{/block}
{block name="script"}
<script type="text/javascript">
    var loginSign = '{$loginSign|default=""}';
    function on_message_call_back(data) {
        //找到聊天列表标记
        var find_sign = false;
        $.each($('ul.message_list'),function(){
            var _thisMessageUl = $(this);
            //找到聊天列表
            if(_thisMessageUl.data('from_id')==data.from_id){
                find_sign = true;
                var messageItemTpl = $('#messageItemTpl');
                messageItemTpl.find('.message_item').attr('data-id',data.id);
                messageItemTpl.find('.msg').text(data.content);
                messageItemTpl.find('.create_time').text(data.create_time);
                if(data.avatar){
                    messageItemTpl.find('img').attr('src',uploads+data.avatar);
                }
                //当前聊天框，则消息设置为已读
                if(_thisMessageUl.hasClass('current')){
                    var postData = {};
                    postData.from_id = data.from_id;
                    postData.messageIds = [];
                    postData.messageIds.push(data.id);
                    var url = domain + 'index/CustomerService/setMessageRead';
                    $.ajax({
                        url: url,
                        data: postData,
                        type: 'post',
                        beforeSend: function(xhr){
                            $('.loading').show();
                        },
                        error:function(xhr){
                            $('.loading').hide();
                            dialog.error('AJAX错误');
                        },
                        success: function(data){
                            $('.loading').hide();
                            if(data.status==0){
                                dialog.error(data.info);
                            }else{
                                //聊天框滚动条置底
                                messageSetBottom();
                                messageItemTpl.find('.message_item').removeClass('unread').addClass('read');
                                _thisMessageUl.append(messageItemTpl.html());
                            }
                        }
                    });
                }else{
                    //非当前聊天框
                    $.each($('li.custom_item'),function(){
                        var _thisCustomLi = $(this);
                        if(_thisCustomLi.data('from_id')==data.from_id){
                            var num = _thisCustomLi.find('span.news_num').text();
                            _thisCustomLi.find('span.news_num').text(++num);
                            _thisMessageUl.append(messageItemTpl.html());
                        }
                    });
                }
            }
        });
        if(!find_sign){
            //未找到聊天列表，则追加一个
            console.log(data);
            var customItemLi = $('#customItemTpl').find('li');
            customItemLi.find('.custom_item').attr('data-id',data.id).attr('data-from_id',data.from_id);
            customItemLi.find('.msg').text(data.content);
            customItemLi.find('.create_time').text(data.create_time);
            customItemLi.find('.author').text(data.from_name);
            if(data.avatar){
                customItemLi.find('img').attr('src',uploads+data.avatar);
            }
            $('ul.custom_list').append(customItemLi);
        }
    }
    //聊天框滚动条置底
	function messageSetBottom() {
		$('.message_list.current').scrollTop($('.message_list.current')[0].scrollHeight);
	}
</script>
<script type="text/javascript" src="public_js/web-socket.js"></script>
<script type="text/javascript">
    var loginSign = '{$loginSign|default=""}';
    $(function () {
        //页面初始化
        var config = {
            url: action,
            container:$('section.chat_content')
        };
        getList(config);
        //切换聊天对象
        $('body').on('click','li.custom_item',function(){
            var _thisCustomLi=$(this);
            _thisCustomLi.addClass('current').siblings().removeClass('current');
            $('.message_list').removeClass('current').eq(_thisCustomLi.index()).addClass('current');
            var curLength=$('ul.message_list.current').find('li').length;
            if(curLength){
                //聊天框滚动条置底
                messageSetBottom();
            }
            var postData = {};
            postData.messageIds = [];
            postData.from_id = _thisCustomLi.data('from_id');
            $.each($('ul.message_list'),function(){
                var _thisMessageUl = $(this);
                if(postData.from_id==_thisMessageUl.data('from_id')){
                    $.each(_thisMessageUl.find('li.message_item.others.unread'),function(){
                        postData.messageIds.push($(this).data('id'));
                    });
                }
            });
            //设置信息已读
            setMessageRead(_thisCustomLi,postData);
        });
        //发送聊天内容
        $('body').on('click','.send_btn',function(){
            var _this = $(this);
            //当前聊天对象
            var _currentUl = $('ul.message_list.current');
            if(!_currentUl.length){
                dialog.error('请选择聊天对象！');
                return false;
            }
            var content = _this.prev().val();
            if(!content){
                dialog.error('不能发送空内容！');
                return false;
            }
            var to_user_id = _currentUl.data('from_id');
            var postData = {to_user_id:to_user_id,content:content};
            var url = domain + 'index/CustomerService/sendMessage';
             $.ajax({
                 url: url,
                 data: postData,
                 type: 'post',
                 beforeSend: function(xhr){
                     $('.loading').show();
                 },
                 error:function(xhr){
                     $('.loading').hide();
                     dialog.error('AJAX错误');
                 },
                 success: function(data){
                     $('.loading').hide();
                     if(data.status==0){
                         dialog.error(data.info);
                     }else{
                         _currentUl.append(data);
                         _this.prev().val('');
                         //聊天框滚动条置底
                         messageSetBottom();
                     }
                 }
             });
        });
        //删除
        $('body').on('click','.detele_chat',function(e){
            e.stopPropagation();
            var _thisCustomLi=$(this).parent();
            var postData = {};
            postData.from_id = _thisCustomLi.find('ul').data('from_id');
            postData.messageIds = [];
            $.each(_thisCustomLi.find('li'),function(){
                postData.messageIds.push($(this).data('id'));
            });
            var url = domain + 'index/CustomerService/delCustomerMessage';
            $.ajax({
                url: url,
                data: postData,
                type: 'post',
                beforeSend: function(xhr){
                    $('.loading').show();
                },
                error:function(xhr){
                    $('.loading').hide();
                    dialog.error('AJAX错误');
                },
                success: function(data){
                    $('.loading').hide();
                    if(data.status==0){
                        dialog.error(data.info);
                    }else{
                        _thisCustomLi.remove();
                    }
                }
            });
        });
        //搜索聊天客户
        $('body').on('click','.search_btn', function() {
            var searchText=$(this).next().val();
            if(!searchText){
                dialog.error('请输入名字搜索');
                return false;
            }
            $('.chat_left .chat_list').each(function(index,val){
                var _this=$(this);
                var name=_this.find('.customer_name').text();
                if(searchText==name){
                    _this.show().siblings().hide();
                    $('.list').find('.no_info').hide();
                    return false;
                }else{
                    _this.hide();
                    $('.list .no_info').remove();
                    $('.list').empty().append('<li class="no_info">暂无此人</li>');
                }
            });
        });
    });
</script>
{/block}