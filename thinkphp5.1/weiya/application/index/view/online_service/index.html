{extend name="template/base.html" /}
{block name="content"}
<section id="chatListOtherTpl" style="display:none;">
	<li class="others unread">
		<div class="avatar">
			<img src="public_img/default/chat_head.jpg">
		</div>
		<div class="content">
			<p class="author">乔峰<span class="create_time">2019-01-07 17:37</span></p>
			<div class="msg"></div>
		</div>
	</li>
</section>
<article class="f24">
	<section class="navigate">
		<ul class="nav_menu weiya_menu service_menu">
			<li>
				<a href="{:url('Consultation/index')}">定制需求留言</a>
			</li>
			<li class="current">
				<a href="{:url('OnlineService/index')}">在线客服咨询</a>
			</li>
		</ul>
	</section>
	<section id="chatLayerContainer">
		<div class="ws_chatMsg-panel flex1">
			<div class="chatMsg-ct">
				<ul class="clearfix chat_item list"></ul>
			</div>
		</div>
		<div class="bottom_nav_fixed chat_bottom_fixed">
			<div class="bottom_flex">
				<input class="send_out_text" type="text" name="" value="">
				<input class="send_btn" type="button" value="发送">
			</div>
		</div>
	</section>
</article>
<section class="bottom_nav_fixed bottom_white">
	<nav class="foot_nav_bar">
		<ul class="columns_flex">
			<li class="each_column">
				<a href="{:url('Index/index')}">
					<span class="store f_icon"></span>
					<span class="f_txt">药妆定制</span>
				</a>
			</li>
			<li class="each_column">
				<a href="{:url('Company/index')}">
					<span class="practitioners f_icon"></span>
					<span class="f_txt">走进维雅</span>
				</a>
			</li>
			<li class="each_column current">
				<a href="{:url('Consultation/index')}">
					<span class="business f_icon"></span>
					<span class="f_txt">业务咨询</span>
				</a>
			</li>
			<li class="each_column">
				<a href="javascript:void(0)" class="my_cart">
					<span class="cart f_icon"></span>
					<span class="f_txt">采购车</span>
				</a>
			</li>
			<li class="each_column">
				<a href="{:url('Mine/index')}">
					<span class="my f_icon"></span>
					<span class="f_txt">我的</span>
				</a>
			</li>
		</ul>
	</nav>
</section>
{/block}
{block name="footer"}{/block}
{block name="script"}
<script type="text/javascript">
	var loginSign = '{$loginSign|default=""}';
	function on_message_call_back(data) {
		var chatListOtherTpl = $('#chatListOtherTpl');
		chatListOtherTpl.find('.msg').text(data.content);
		chatListOtherTpl.find('.author').text(data.from_name);
		chatListOtherTpl.find('.create_time').text(data.create_time);
		chatListOtherTpl.find('li').attr('data-id',data.id);
		chatListOtherTpl.find('li').attr('data-from_id',data.from_id);
		if(data.avatar){
			chatListOtherTpl.find('img').attr('src',data.avatar);
		}
		//已打开聊天框
		if($('.chatLayer ').length) {
			var postData = {};
			postData.from_id = data.from_id;
			postData.messageIds = [];
			postData.messageIds.push(data.id);
			var url = domain + 'index/CustomerService/setMessageRead';
			$.ajax({
				url: url,
				data: postData,
				type: 'post',
				beforeSend: function (xhr) {
					$('.loading').show();
				},
				error: function (xhr) {
					$('.loading').hide();
					dialog.error('AJAX错误');
				},
				success: function (data) {
					$('.loading').hide();
					if (data.status == 0) {
						dialog.error(data.info);
					} else {
						chatListOtherTpl.find('li').attr('class', 'others read');
						$('.chatLayer .chat_item').append(chatListOtherTpl.html());
						//聊天框滚动条置底
						chatDialogSetBottom();
					}
				}
			});
		}else{
			//未打开聊天框
			var num = $('span.news_num').text();
			$('span.news_num').text(++num);
			$('#chatLayerContainer .chat_item').append(chatListOtherTpl.html());
		}
	}
	//设置信息已读
	function setMessageRead(obj) {
		var postData = {};
		postData.messageIds = [];
		$.each(obj.find('li.others.unread'), function () {
			postData.messageIds.push($(this).data('id'));
			postData.from_id = $(this).data('from_id');
		});
		if (!postData.messageIds.length) {
			return false;
		}
		var url = domain + 'index/CustomerService/setMessageRead';
		$.ajax({
			url: url,
			data: postData,
			type: 'post',
			beforeSend: function (xhr) {
				$('.loading').show();
			},
			error: function (xhr) {
				$('.loading').hide();
				dialog.error('AJAX错误');
			},
			success: function (data) {
				$('.loading').hide();
				if (data.status == 0) {
					dialog.error(data.info);
				} else {
					$('span.news_num').text('');
					$('.chatLayer li.others.unread').removeClass('unread').addClass('read');
				}
			}
		});
	}
	//聊天框滚动条置底
	function chatDialogSetBottom() {
		$('.list').scrollTop($('.list')[0].scrollHeight);
	}
</script>
<script type="text/javascript" src="public_js/web-socket.js"></script>
<script type="text/javascript">
	$(function () {
		//页面初始化
		var config = {
			url: action
		};
		getPagingList(config);
		//发送文本获取焦点
		$('body').on('focus','.send_out_text',function(){
			//聊天框滚动条置底
			chatDialogSetBottom();
		});
		//发送聊天内容
		$('body').on('click','.send_btn',function(){
			var chatListTpl = $('#chatListTpl');
			var _this=$(this).prev();
			if(!_this.val()){
				dialog.error('不能发送空内容！');
				return false;
			}
			var postData = {
				to_user_id:17,
				content:_this.val()
			};
			if(!loginSign){
				postData.from_client_id = clientId;
			}
			var url = domain + 'index/CustomerService/sendMessage';
			$.ajax({
				url: url,
				data: postData,
				type: 'post',
				beforeSend: function(xhr){
					$('.loading').show();
				},
				error:function(xhr){
					$('.loading').hide();
					dialog.error('AJAX错误');
				},
				success: function(data){
					$('.loading').hide();
					if(data.status==0){
						dialog.error(data.info);
					}else{
						$('.list').append(data);
						//聊天框滚动条置底
						chatDialogSetBottom();
						_this.val('');
					}
				}
			});
		});
	});
</script>
{/block}