<!-- 产品选择器 -->
<template id="product_select_tpl">
    <div>
        <div class="columns_flex l-r-sides">
            <p>
                <span class="red deal_price">￥{{deal_price}}</span>
            </p>
            <p v-if="quota_named_display">{{quota_named}}：<span class="quota">{{quota_quantity}}</span></p>
        </div>
        <div class="columns_flex l-r-sides">
            <div>
                <p v-if="buy_named_display">{{buy_named}}：(单位:{{unit}})</p>
                <p v-if="step_named_display">
                    <span class="step-named">{{step_named}}：</span>
                    <span class="step-quantity">{{init_quantity}}</span>
                    <span class="unit">{{unit}}</span>
                </p>
            </div>
            <div>
                <span class="red subtotal_amount">￥{{subtotal_amount}}</span>
            </div>
            <div class="quantity_wrapper selected-number">
                <a href="javascript:void(0);" class="reduce" @click="reduce">-</a>
                <input type="text" :value="buy_quantity" class="f24 product_count" readonly="readonly">
                <a href="javascript:void(0);" class="plus" @click="plus">+</a>
            </div>
        </div>
    </div>
</template>
<script type="text/javascript">
    $(function(){
        Vue.component('product-select', {
            template:'#product_select_tpl',
            props: {
                goods_id: {type: Number,default: 0,required: true},
                buy_named: {type: String,default: '购买数量'},
                buy_named_display: {type: Boolean,default: false},
                step_named: {type: String,default: '起订数量'},
                step_named_display: {type: Boolean,default: false},
                quota_named: {type: String,default: '样品购买限额'},
                quota_named_display: {type: Boolean,default: false},
                quota_quantity: {type: Number,default: 1},
                unit: {type: String,default: '盒'},
                deal_price: {type: Number,default: 0.01},
                init_quantity: {type: Number,default: 1},
                step_quantity: {type: Number,default: 1}
            },
            data: function () {
                return {
                    'buy_quantity':this.init_quantity,
                    'subtotal_amount':0
                };
            },
            methods: {
                subtotal_amount_figure_up:function(){
                    this.subtotal_amount = this.deal_price * this.buy_quantity;
                },
                reduce: function () {
                    if(this.buy_quantity>this.init_quantity){
                        this.buy_quantity -= this.step_quantity;
                        this.subtotal_amount_figure_up();
                        let param = {
                            goods_id:this.goods_id,
                            buy_quantity:this.buy_quantity,
                            deal_price:this.deal_price,
                            step_quantity:this.step_quantity
                        };
                        //触发产品减少事件
                        bus.$emit('subtotal_amount_reduce',param);
                    }
                },
                plus: function () {
                    this.buy_quantity += this.step_quantity;
                    this.subtotal_amount_figure_up();
                    let param = {
                        goods_id:this.goods_id,
                        buy_quantity:this.buy_quantity,
                        deal_price:this.deal_price,
                        step_quantity:this.step_quantity
                    };
                    //触发产品增加事件
                    bus.$emit('subtotal_amount_plus',param);
                }
            },created: function(){
                this.subtotal_amount_figure_up();
                let param = {
                    goods_id:this.goods_id,
                    buy_quantity:this.buy_quantity,
                    subtotal_amount:this.subtotal_amount
                };
                //触发产品小计初始化事件
                bus.$emit('subtotal_amount_init',param);
            }
        });
    });
</script>
<!-- 底栏购物菜单 -->
<template id="footer-cart-menu_tpl">
    <footer class="f24 ">
        <div class="group_cart_nav">
            <a href="javascript:void(0);" v-for="menu in menus" :data-jump_url="menu.action" :class="menu.class" @click="addCart">
                {{menu.name}}
                <!-- 全选 -->
                <div v-if="menu.class.indexOf('checked_all')!==-1">
                    <input type="checkbox" class="check-all">
                    <label for="" class="left">全选</label>
                </div>
                <!-- 总金额 -->
                <div v-else-if="menu.class.indexOf('amount')!==-1">
                    <span class="total_amount">￥{{total_amount}}</span>
                </div>
                <!-- 购物篮 -->
                <div v-else-if="menu.class.indexOf('add_cart_icon')!==-1">
                    <span class="add_num"></span>
                    <span class="cart_num"></span>
                </div>
                <!-- 默认 -->
                <div v-else>
                    <span class="s_i"></span>
                </div>
            </a>
        </div>
    </footer>
</template>
<script type="text/javascript">
    $(function(){
        var unlockingFooterCart = '{$unlockingFooterCart|raw}';
        if(unlockingFooterCart){
            unlockingFooterCart = JSON.parse(unlockingFooterCart);
            Vue.component('footer-cart-menu', {
                template:'#footer-cart-menu_tpl',
                data: function () {
                    return {
                        total_amount:0,
                        menus: unlockingFooterCart.menu,
                        postData:{
                            goodsList:[]
                        }
                    }
                },
                methods: {
                    total_amount_init:function (param) {
                        //初始化总计
                        this.total_amount += param.subtotal_amount;
                        //初始化产品列表
                        if(param.buy_quantity>0){
                            let obj = {
                                'goods_id':param.goods_id,
                                'buy_quantity':param.buy_quantity
                            };
                            this.postData.goodsList.push(obj);
                        }
                    },
                    reduce: function (param) {
                        console.log(param);
                        this.total_amount -= param.deal_price * param.step_quantity;
                        //更新产品列表
                        for(var i = 0,len = this.postData.goodsList.length; i < len; i++){
                            if(this.postData.goodsList[i] == param.goods_id){
                                if(param.buy_quantity==0){
                                    Vue.delete(this.postData.goodsList,i);
                                }else{
                                    this.postData.goodsList[i]['buy_quantity'] = param.buy_quantity;
                                }
                                break;
                            }
                        }
                    },
                    plus: function (param) {
                        console.log(param);
                        this.total_amount += param.deal_price * param.step_quantity;
                        //更新产品列表
                        for(var i = 0,len = this.postData.goodsList.length; i < len; i++){
                            if(this.postData.goodsList[i] == param.goods_id){
                                console.log(this.postData.goodsList[i]['buy_quantity']);
                                this.postData.goodsList[i]['buy_quantity'] = param.buy_quantity;
                                console.log(this.postData.goodsList[i]['buy_quantity']);
                                break;
                            }
                        }
                    },
                    addCart:function(){
                        console.log(this.postData);
                    }
                },created:function(){
                    let _this = this;
                    //监听产品小计初始化
                    bus.$on('subtotal_amount_init', function(param){
                        //产品总计初始化
                        _this.total_amount_init(param);
                    });
                    //监听产品增加
                    bus.$on('subtotal_amount_reduce', function(param){
                        _this.reduce(param);
                    });
                    //监听产品减少
                    bus.$on('subtotal_amount_plus', function(param){
                        _this.plus(param);
                    });
                }
            });
        }
    });
</script>